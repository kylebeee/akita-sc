{"version":3,"sources":["../src/wallet/utils.ts"],"sourcesContent":["import algosdk, { Address, AtomicTransactionComposer, decodeAddress } from \"algosdk\";\nimport { AllowanceInfo as SubAllowanceInfo } from \"../generated/AbstractedAccountClient\";\nimport { AddAllowanceArgs, AllowanceInfo } from \"./types\";\nimport { encodeLease } from \"@algorandfoundation/algokit-utils\";\nimport { PluginHookParams } from \"../types\";\nimport { Txn } from \"@algorandfoundation/algokit-utils/types/composer\";\nimport { AlgoAmount } from \"@algorandfoundation/algokit-utils/types/amount\";\n// import { AppCallParams, AppUpdateParams, Txn } from \"@algorandfoundation/algokit-utils/types/composer\";\n\n\n// AppCallParams | AppCreateParams | AppUpdateParams\n\n// export function isAppCall(params: Txn): params is AppCallParams {\n//   return params.type === 'appCall' && 'appId' in params;\n// }\n\nexport function SpendAllowanceTypeFromString(type: string): bigint {\n  switch (type) {\n    case 'flat': { return 1n }\n    case 'window': { return 2n }\n    case 'drip': { return 3n }\n    default: {\n      throw new Error(`Invalid allowance type: ${type}`);\n    }\n  }\n}\n\nexport function AllowancesToTuple(allowances: AddAllowanceArgs[]): [number | bigint, number | bigint, number | bigint, number | bigint, number | bigint, boolean][] {\n  return allowances.map(({ asset, type, useRounds = false, ...rest }) => {\n    const max = 'max' in rest ? rest.max : 0n;\n    const interval = 'interval' in rest ? rest.interval : 0n;\n    const amount = 'amount' in rest ? rest.amount : 'rate' in rest ? rest.rate : 0n;\n    return [asset, SpendAllowanceTypeFromString(type), amount, max, interval, useRounds];\n  }) as [number | bigint, number | bigint, number | bigint, number | bigint, number | bigint, boolean][];\n}\n\nexport function AllowanceInfoTranslate(info: SubAllowanceInfo): AllowanceInfo {\n\n  const commonFields = {\n    last: info.last,\n    start: info.start,\n    useRounds: info.useRounds\n  }\n\n  switch (info.type) {\n    case 1:\n      return {\n        type: 'flat',\n        amount: info.amount,\n        spent: info.spent,\n        ...commonFields\n      };\n    case 2:\n      return {\n        type: 'window',\n        amount: info.amount,\n        spent: info.spent,\n        interval: info.interval,\n        ...commonFields\n      };\n    case 3:\n      return {\n        type: 'drip',\n        lastLeftover: info.spent,\n        max: info.max,\n        rate: info.amount,\n        interval: info.interval,\n        ...commonFields\n      };\n    default:\n      throw new Error(`Unknown allowance type ${info.type}`);\n  }\n}\n\nexport function executionBoxKey(lease: string): Uint8Array {\n\n  const prefix = new Uint8Array(Buffer.from('x'));\n  const encodedLease = encodeLease(lease)!;\n\n  const result = new Uint8Array(prefix.length + encodedLease.length);\n  result.set(prefix, 0);\n  result.set(encodedLease, prefix.length);\n\n  return result;\n}\n\nexport function domainBoxKey(address: string | Address): Uint8Array {\n  return new Uint8Array(\n    Buffer.concat([\n      Buffer.from('d'),\n      typeof address === 'string' ? decodeAddress(address).publicKey : address.publicKey\n    ])\n  );\n}\n\nexport type OverWriteProperties = {\n  sender?: string | algosdk.Address;\n  signer?: algosdk.TransactionSigner;\n  firstValid?: bigint;\n  lastValid?: bigint;\n  lease?: Uint8Array | string;\n  fees?: Map<number, AlgoAmount>;\n};\n\nexport function forceProperties(\n  atc: AtomicTransactionComposer,\n  options: OverWriteProperties\n): AtomicTransactionComposer {\n  const group = atc.clone().buildGroup();\n  const newAtc = new algosdk.AtomicTransactionComposer();\n\n  const overWriteProperties = (txn: any, index: number, options: OverWriteProperties) => {\n    txn.txn['group'] = undefined;\n\n    txn.txn['lease'] = (options.lease !== undefined && index === 0)\n      ? (typeof options.lease === 'string'\n        ? encodeLease(options.lease)\n        : options.lease)\n      : txn.txn['lease'];\n\n    txn['signer'] = options.signer !== undefined\n      ? options.signer\n      : txn['signer'];\n\n    txn.txn['sender'] = options.sender !== undefined\n      ? (typeof options.sender === 'string'\n        ? decodeAddress(options.sender)\n        : options.sender)\n      : txn.txn['sender'];\n\n    txn.txn['firstValid'] = options.firstValid !== undefined\n      ? options.firstValid\n      : txn.txn['firstValid'];\n\n    txn.txn['lastValid'] = options.lastValid !== undefined\n      ? options.lastValid\n      : txn.txn['lastValid'];\n\n    txn.txn['fee'] = options.fees !== undefined && options.fees.has(index) && options.fees.get(index)?.microAlgo !== undefined\n      ? options.fees.get(index)?.microAlgo\n      : txn.txn['fee']\n  }\n\n  group.forEach((t, i) => {\n    overWriteProperties(t, i, options);\n    newAtc.addTransaction(t);\n  });\n\n  // Preserve method calls\n  newAtc['methodCalls'] = atc['methodCalls'];\n\n  return newAtc;\n}\n\nexport class ValueMap<K extends object, V> {\n  private map = new Map<string, V>();\n  private keyGenerator: (obj: K) => string;\n\n  constructor(keyGenerator: (obj: K) => string, iterable?: Iterable<readonly [K | Partial<K> | string, V]>) {\n    this.keyGenerator = keyGenerator;\n    if (iterable) {\n      for (const [key, value] of iterable) {\n        this.set(key, value);\n      }\n    }\n  }\n\n  private generateKey(key: K | Partial<K> | string): string {\n    if (typeof key === 'string') {\n      return key;\n    }\n    // If it's a partial key, we need to call the key generator which should handle defaults\n    return this.keyGenerator(key as K);\n  }\n\n  set(key: K | Partial<K> | string, value: V): this {\n    const stringKey = this.generateKey(key);\n    this.map.set(stringKey, value);\n    return this;\n  }\n\n  get(key: K | Partial<K> | string): V | undefined {\n    const stringKey = this.generateKey(key);\n    return this.map.get(stringKey);\n  }\n\n  has(key: K | Partial<K> | string): boolean {\n    const stringKey = this.generateKey(key);\n    return this.map.has(stringKey);\n  }\n\n  delete(key: K | Partial<K> | string): boolean {\n    const stringKey = this.generateKey(key);\n    return this.map.delete(stringKey);\n  }\n\n  clear(): void {\n    this.map.clear();\n  }\n\n  get size(): number {\n    return this.map.size;\n  }\n\n  keys(): IterableIterator<string> {\n    return this.map.keys();\n  }\n\n  values(): IterableIterator<V> {\n    return this.map.values();\n  }\n\n  entries(): IterableIterator<[string, V]> {\n    return this.map.entries();\n  }\n\n  forEach(callbackfn: (value: V, key: string, map: Map<string, V>) => void): void {\n    this.map.forEach(callbackfn);\n  }\n\n  [Symbol.iterator](): IterableIterator<[string, V]> {\n    return this.map[Symbol.iterator]();\n  }\n}\n\nexport const getTxns = async ({ }: PluginHookParams) => { return [{}] as Txn[] }"],"mappings":"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","names":["options"]}